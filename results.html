<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>R√©sultats ‚Äì Waygo</title>
    <link rel="stylesheet" href="styles.css" />
</head>

<body>

<header>
    <a href="index.html" class="logo">
        <img src="logo.png" alt="Waygo" />
        <span>Waygo</span>
    </a>
</header>

<section class="content">
    <h1 id="title">R√©sultats</h1>

    <div class="category"><h2>‚úàÔ∏è Vols recommand√©s</h2></div>
    <div id="flights" class="results-box"></div>

    <div class="category"><h2>üè® H√¥tels recommand√©s</h2></div>
    <div id="hotels" class="results-box"></div>
</section>

<script>
// --- 1. –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL ---
const url = new URL(window.location.href);
const cityName = url.searchParams.get("city");

// –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.getElementById("title").innerText = `R√©sultats pour ${cityName.toUpperCase()}`;

// --- 2. –ü–æ–ª—É—á–∞–µ–º IATA –∫–æ–¥ –≥–æ—Ä–æ–¥–∞ ---
async function getCityCode(city) {
    const tokenRes = await fetch("/.netlify/functions/token");
    const tokenData = await tokenRes.json();

    const res = await fetch(
        `https://test.api.amadeus.com/v1/reference-data/locations?subType=CITY&keyword=${city}`,
        {
            headers: {
                Authorization: `Bearer ${tokenData.access_token}`
            }
        }
    );

    const json = await res.json();
    return json.data?.[0]?.iataCode || null;
}

// --- 3. –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–π—Å—ã ---
async function loadFlights(code) {
    const box = document.getElementById("flights");
    box.innerHTML = `<div class="loader"></div>`;

    const res = await fetch(`/.netlify/functions/flight?city=${code}`);
    const json = await res.json();

    box.innerHTML = "";

    if (!json.data) {
        box.innerHTML = "<p>Aucun vol trouv√©.</p>";
        return;
    }

    json.data.forEach(flight => {
        box.innerHTML += `
            <div class="card">
                <p><strong>Prix:</strong> ${flight.price.total} ‚Ç¨</p>
                <p><strong>Compagnie:</strong> ${flight.validatingAirlineCodes}</p>
            </div>
        `;
    });
}

// --- 4. –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç–µ–ª–∏ ---
async function loadHotels(code) {
    const box = document.getElementById("hotels");
    box.innerHTML = `<div class="loader"></div>`;

    const res = await fetch(`/.netlify/functions/hotels?city=${code}`);
    const json = await res.json();

    box.innerHTML = "";

    if (!json.data) {
        box.innerHTML = "<p>Aucun h√¥tel trouv√©.</p>";
        return;
    }

    json.data.forEach(hotel => {
        const info = hotel.hotel;
        const offer = hotel.offers[0];

        box.innerHTML += `
            <div class="card">
                <p><strong>${info.name}</strong></p>
                <p>üìç ${info.address.cityName}</p>
                <p><strong>${offer.price.total} ‚Ç¨</strong> / nuit</p>
            </div>
        `;
    });
}

// --- 5. –ì–ª–∞–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ ---
(async () => {
    const code = await getCityCode(cityName); // –ü—Ä–∏–º–µ—Ä: PAR ‚Üí PAR; Tokyo ‚Üí TYO; Madrid ‚Üí MAD

    if (!code) {
        alert("Ville inconnue");
        return;
    }

    loadFlights(code);
    loadHotels(code);
})();
</script>

</body>
</html>