<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√©sultats ‚Äì Waygo</title>
    <link rel="stylesheet" href="styles.css">

    <style>
        .results-title {
            font-size: 32px;
            text-align: center;
            color: #0d6efd;
            margin-top: 20px;
        }

        .sub-title {
            font-size: 22px;
            margin-top: 40px;
            margin-bottom: 20px;
            color: #0d6efd;
        }

        .flight-card, .hotel-card {
            padding: 20px;
            background: white;
            border-radius: 14px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            transition: 0.2s;
        }

        .flight-card:hover, .hotel-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .hotel-img {
            width: 100%;
            height: 160px;
            border-radius: 14px;
            object-fit: cover;
            margin-bottom: 10px;
        }

        .loader {
            margin: 30px auto;
            border: 5px solid #ddd;
            border-top: 5px solid #0d6efd;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>

<body>

<header>
    <div class="logo-box">
        <img src="logo.png" class="logo">
        <h1>Waygo</h1>
    </div>
</header>

<section class="content">

    <h2 class="results-title">
        R√©sultats pour <span id="city-name"></span>
    </h2>

    <h3 class="sub-title">‚úàÔ∏è Vols recommand√©s</h3>
    <div id="flights"><div class="loader"></div></div>

    <h3 class="sub-title">üè® H√¥tels recommand√©s</h3>
    <div id="hotels"><div class="loader"></div></div>

</section>

<script>
const params = new URLSearchParams(window.location.search);
const city = params.get("city");
document.getElementById("city-name").textContent = city;

/* –ü–æ–ª—É—á–µ–Ω–∏–µ IATA-–∫–æ–¥–∞ */
async function getCityCode(city) {
    const res = await fetch(`/.netlify/functions/token`);
    const { access_token } = await res.json();

    const codeRes = await fetch(
        `https://test.api.amadeus.com/v1/reference-data/locations?subType=CITY&keyword=${city}`,
        { headers: { Authorization: `Bearer ${access_token}` }}
    );

    const json = await codeRes.json();
    return json.data?.[0]?.iataCode || "TYO";
}

/* –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–π—Å–æ–≤ */
async function loadFlights(code) {
    const res = await fetch(`/.netlify/functions/flight?city=${code}`);
    const json = await res.json();

    const box = document.getElementById("flights");
    box.innerHTML = "";

    json.data?.forEach(f => {
        box.innerHTML += `
            <div class="flight-card">
                <h4>Paris ‚Üí ${city}</h4>
                <p><strong>Compagnie:</strong> ${f.validatingAirlineCodes[0]}</p>
                <p><strong>Prix:</strong> ${f.price.total} ‚Ç¨</p>
            </div>
        `;
    });
}

/* –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–µ–ª–µ–π */
async function loadHotels(code) {
    const res = await fetch(`/.netlify/functions/hotels?city=${code}`);
    const json = await res.json();

    const box = document.getElementById("hotels");
    box.innerHTML = "";

    json.data?.slice(0,3).forEach(h => {
        box.innerHTML += `
            <div class="hotel-card">
                <img src="${h.hotel.media?.[0]?.uri || 'no-photo.jpg'}" class="hotel-img">
                <h4>${h.hotel.name}</h4>
                <p><strong>Prix:</strong> ${h.offers?.[0]?.price.total || "?"} ‚Ç¨</p>
                <p><strong>Note:</strong> ${h.hotel.rating || "N/A"}</p>
            </div>
        `;
    });
}

/* –ó–∞–ø—É—Å–∫ */
(async () => {
    const code = await getCityCode(city);
    loadFlights(code);
    loadHotels(code);
})();
</script>

</body>
</html>