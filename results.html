<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√©sultats ‚Äì Waygo</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>

<header>
    <a href="index.html" class="logo">
        <img src="logo.png" alt="Waygo">
        <span>Waygo</span>
    </a>
</header>

<section class="content">
    <h1 id="title">R√©sultats</h1>

    <div class="category"><h2>‚úàÔ∏è Vols recommand√©s</h2></div>
    <div id="flights" class="results-box"></div>

    <div class="category"><h2>üè® H√¥tels recommand√©s</h2></div>
    <div id="hotels" class="results-box"></div>
</section>

<script>
// --- –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ ---
const url = new URL(window.location.href);
const cityName = url.searchParams.get("city");

document.getElementById("title").innerText = `R√©sultats pour ${cityName.toUpperCase()}`;

// --- –ü–æ–ª—É—á–∞–µ–º IATA –∫–æ–¥ ---
async function getCityCode(city) {
    const tok = await fetch("/.netlify/functions/token");
    const { access_token } = await tok.json();

    const res = await fetch(
        `https://test.api.amadeus.com/v1/reference-data/locations?subType=CITY&keyword=${city}`,
        { headers: { Authorization: `Bearer ${access_token}` }}
    );

    const json = await res.json();

    return json.data?.[0]?.iataCode || null;
}

// --- –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã ---
async function getCoordinates(city) {
    const tok = await fetch("/.netlify/functions/token");
    const { access_token } = await tok.json();

    const res = await fetch(
        `https://test.api.amadeus.com/v1/reference-data/locations?subType=CITY&keyword=${city}`,
        { headers: { Authorization: `Bearer ${access_token}` }}
    );

    const json = await res.json();
    const loc = json.data?.[0];

    if (!loc) return null;

    return {
        lat: loc.geoCode.latitude,
        lon: loc.geoCode.longitude
    };
}

// --- –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–π—Å—ã ---
async function loadFlights(iata) {
    const box = document.getElementById("flights");
    box.innerHTML = `<div class="loader"></div>`;

    const res = await fetch(`/.netlify/functions/flight?city=${iata}`);
    const data = await res.json();

    box.innerHTML = "";

    if (!data.data) {
        box.innerHTML = "<p>Aucun vol trouv√©.</p>";
        return;
    }

    data.data.forEach(f => {
        box.innerHTML += `
            <div class="card">
                <p><b>Prix:</b> ${f.price.total}‚Ç¨</p>
                <p><b>Compagnie:</b> ${f.validatingAirlineCodes}</p>
            </div>
        `;
    });
}

// --- –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç–µ–ª–∏ ---
async function loadHotels(lat, lon) {
    const box = document.getElementById("hotels");
    box.innerHTML = `<div class="loader"></div>`;

    const res = await fetch(`/.netlify/functions/hotels?lat=${lat}&lon=${lon}`);
    const data = await res.json();

    box.innerHTML = "";

    if (!data.data) {
        box.innerHTML = "<p>Aucun h√¥tel trouv√©.</p>";
        return;
    }

    data.data.forEach(h => {
        box.innerHTML += `
            <div class="card">
                <p><b>${h.hotel.name}</b></p>
                <p>üìç ${h.hotel.address.cityName}</p>
                <p><b>${h.offers[0].price.total}‚Ç¨</b> / nuit</p>
            </div>
        `;
    });
}

// --- –ì–õ–ê–í–ù–´–ô –ó–ê–ü–£–°–ö ---
(async () => {
    const iata = await getCityCode(cityName);
    const coords = await getCoordinates(cityName);

    if (!iata) {
        alert("Ville inconnue");
        return;
    }

    loadFlights(iata);

    if (coords) {
        loadHotels(coords.lat, coords.lon);
    } else {
        document.getElementById("hotels").innerHTML = "Aucun h√¥tel trouv√©.";
    }
})();
</script>

</body>
</html>