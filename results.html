<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√©sultats ‚Äì Waygo</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>

<header>
    <a href="index.html" class="logo">
        <img src="logo.png">
        <span>Waygo</span>
    </a>
</header>

<section class="content">
    <h1 id="title">R√©sultats</h1>

    <div class="category"><h2>‚úàÔ∏è Vols recommand√©s</h2></div>
    <div id="flights" class="results-box"><div class="loader"></div></div>

    <div class="category"><h2>üè® H√¥tels recommand√©s</h2></div>
    <div id="hotels" class="results-box"><div class="loader"></div></div>
</section>

<script>
const url = new URL(window.location.href);
const cityName = url.searchParams.get("city");

document.getElementById("title").innerText = "R√©sultats pour " + cityName;

// === GET IATA ===
async function getCityCode(city) {
    const t = await fetch("/.netlify/functions/token");
    const { access_token } = await t.json();

    const r = await fetch(
        `https://api.amadeus.com/v1/reference-data/locations?subType=CITY&keyword=${city}`,
        { headers: { Authorization: `Bearer ${access_token}` }}
    );

    const data = await r.json();
    return data?.data?.[0]?.iataCode || null;
}

// === GET COORDS ===
async function getCoordinates(city) {
    const t = await fetch("/.netlify/functions/token");
    const { access_token } = await t.json();

    const r = await fetch(
        `https://api.amadeus.com/v1/reference-data/locations?subType=CITY&keyword=${city}`,
        { headers: { Authorization: `Bearer ${access_token}` }}
    );

    const data = await r.json();
    const loc = data.data?.[0];
    return loc ? { lat: loc.geoCode.latitude, lon: loc.geoCode.longitude } : null;
}

// === LOAD FLIGHTS ===
async function loadFlights(iata) {
    const res = await fetch(`/.netlify/functions/flight?city=${iata}`);
    const json = await res.json();

    const box = document.getElementById("flights");
    box.innerHTML = "";

    if (!json.data) return box.innerHTML = "<p>Aucun vol trouv√©.</p>";

    json.data.forEach(f => {
        box.innerHTML += `
        <div class="card">
            <p><b>Prix:</b> ${f.price.total}‚Ç¨</p>
            <p><b>Compagnie:</b> ${f.validatingAirlineCodes}</p>
        </div>`;
    });
}

// === LOAD HOTELS ===
async function loadHotels(lat, lon) {
    const res = await fetch(`/.netlify/functions/hotels?lat=${lat}&lon=${lon}`);
    const json = await res.json();

    const box = document.getElementById("hotels");
    box.innerHTML = "";

    if (!json.data) return box.innerHTML = "<p>Aucun h√¥tel trouv√©.</p>";

    json.data.forEach(h => {
        box.innerHTML += `
        <div class="card">
            <p><b>${h.hotel.name}</b></p>
            <p>üìç ${h.hotel.address.cityName}</p>
            <p><b>${h.offers[0].price.total}‚Ç¨</b> / nuit</p>
        </div>`;
    });
}

// === MAIN ===
(async () => {
    const iata = await getCityCode(cityName);
    const coords = await getCoordinates(cityName);

    if (!iata) return alert("Ville inconnue.");

    loadFlights(iata);
    coords ? loadHotels(coords.lat, coords.lon) : null;
})();
</script>

</body>
</html>